<!DOCTYPE html>

<html lang="en">
	<head>
		<title>Aaeria | Widgets</title>
		<link rel="icon" href="assets/images/logo.ico" type="image/icon">
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="assets/styles.css" type="text/css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
	</head>
	<body>
		<header>
			<h1><a href="index.html">Widgets</a></h1>
			<a href="https://aaeria.me"><img src="assets/images/logo.ico" alt="logo"></a>
		</header>
		<div class="main">
			<a href="index.html">Back</a>
			<h1>Rock Paper Scissors</h1>
			<p>This program tries to play rock paper scissors by predicting your next move. It will improve as you play more games against it (can take up to 50 games in my experience).</p>
			<div>
				<button onClick="move(0)">Rock</button>
				<button onClick="move(1)">Paper</button>
				<button onClick="move(2)">Scissors</button>
			</div>
			<div style="font-size: 10px;">
				<p id="prediction"></p>
				<p id="prediction2"></p>
			</div>
			<table id="rpshistory">
				<tr>
					<th>Round</th>
					<th>Player</th>
					<th>Computer</th>
					<th>Winner</th>
					<th>Score</th>
					<th>Computer win rate</th>
				</tr>
			</table>
		</div>
		<footer>
			<a href="https://github.com/zzaria/widgets"><i class="fab fa-github"></i></a>
			<div class="bottom">
				<p>2020 | <a href="https://aaeria.me">Aaeria</a></p>
			</div>
		</footer>
	</body>
	<script>
		let playerScore=0;
		let computerScore=0;
		let roundNumb=0;
		let nextMove=Math.floor(Math.random()*3);
		const moveNames=["Rock","Paper","Scissors"];
		let n=3;
		let history=Array(n).fill(0);
		let prediction=Array(Math.pow(10,n)).fill().map(()=>Array(3).fill(1));
		let nextRandom=Math.floor(Math.random()*1000);
		function winner(a,b){
			a=(b-a+3)%3;
			if(a==0){
				return 'Tie';
			}
			else if(a==1){
				playerScore++;
				return 'Player';
			}
			else{
				computerScore++;
				return 'Computer';
			}
		}
		function state(){
			return history.reduce((s,x) => s*10+x+1);
		}
		function move(m){
			let s=state();
			for(let i=0;i<3;i++)
				prediction[s][i]*=2/3;
			prediction[s][m]+=1;

			history=history.slice(1).concat(3*m+0*nextMove);

			let computerMove=nextMove;
			s=state();
			let x=prediction[s].reduce((s,x)=> s+x);
			x*=Math.random();
			for(let i=0;i<3;i++){
				if(prediction[s][i]>x){
					nextMove=(i+1)%3;
					break;
				}
				x-=prediction[s][i];
			}

			console.log(s,prediction[s],nextMove);

			async function sha256(message) {
				// encode as UTF-8
				const msgBuffer = new TextEncoder().encode(message);                    

				// hash the message
				const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

				// convert ArrayBuffer to Array
				const hashArray = Array.from(new Uint8Array(hashBuffer));

				// convert bytes to hex string                  
				const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
				return hashHex;
			}
			let move=moveNames[nextMove]+nextRandom;
			sha256(move).then((value) => {document.getElementById('prediction2').innerText="last hash:"+ move+" -> "+value;});
			nextRandom=Math.floor(Math.random()*1000);
			move=moveNames[computerMove]+nextRandom;
			sha256(move).then((value) => {document.getElementById('prediction').innerText="hash(next move)="+value;});
			
			roundNumb++;

			h=document.getElementById('rpshistory').innerHTML;
			h=h.slice(0,163)+`
				<tr>
					<td>${roundNumb}</td>
					<td>${moveNames[m]}</td>
					<td>${moveNames[computerMove]}</td>
					<td>${winner(computerMove,m)}</td>
					<td>${playerScore-computerScore}</td>
					<td>${computerScore/Math.max(computerScore+playerScore,1)}</td>
				</tr>
				`+h.slice(163);
			document.getElementById('rpshistory').innerHTML=h;
		}
	</script>
</html>